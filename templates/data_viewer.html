<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - AI Career Tools</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/styles.css') }}" rel="stylesheet">
    <style>
        /* Add styles for difficulty badges like in the DSA submissions page */
        .difficulty-badge-easy {
            background-color: #28a745;
        }
        .difficulty-badge-medium {
            background-color: #ffc107;
            color: #212529;
        }
        .difficulty-badge-hard {
            background-color: #dc3545;
        }
        /* Reuse the solution-code and analysis-content styles */
        .solution-code {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }
        .analysis-content {
            background-color: #f0f8ff; 
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #0d6efd;
        }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">PrepPoint</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="/">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/resume-analyzer">Resume Analyzer</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/interview">Interview Assistant</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/dsa-questions">DSA Practice</a>
                    </li>
                </ul>
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/data-viewer">{{ session.user_name }}'s Dashboard</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    <div class="hero-section">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="display-5">My Dashboard</h1>
                    <p class="lead">Welcome back, {{ session.user_name }}</p>
                </div>
                <div>
                    <a href="{{ url_for('auth.profile') }}" class="btn btn-light me-2">Profile</a>
                    <a href="{{ url_for('auth.logout') }}" class="btn btn-outline-light">Logout</a>
                </div>
            </div>
        </div>
    </div>

    <div class="container mb-5">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card stats-card">
                    <h2>{{ resume_count }}</h2>
                    <p>Resume Analyses</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <h2>{{ interview_count }}</h2>
                    <p>Interview Sessions</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <h2>{{ dsa_count|default(0) }}</h2>
                    <p>DSA Submissions</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <h2>{{ profile_completion }}%</h2>
                    <p>Profile Completion</p>
                </div>
            </div>
        </div>

        <div class="container mt-4">
            <h1 class="mb-4">Data Viewer</h1>
            
            <div class="filter-section">
                <div class="row">
                    <div class="col-md-6">
                        <input type="text" id="searchInput" class="form-control" placeholder="Search by candidate name...">
                    </div>
                    <div class="col-md-3">
                        <select id="dateFilter" class="form-select">
                            <option value="all">All Dates</option>
                            <option value="today">Today</option>
                            <option value="week">This Week</option>
                            <option value="month">This Month</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <button id="refreshData" class="btn btn-primary w-100">Refresh Data</button>
                    </div>
                </div>
            </div>
    
            <ul class="nav nav-tabs" id="dataTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="resume-tab" data-bs-toggle="tab" data-bs-target="#resume-data" type="button" role="tab">
                        Resume Analyses
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="interview-tab" data-bs-toggle="tab" data-bs-target="#interview-data" type="button" role="tab">
                        Interview Transcripts
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="dsa-tab" data-bs-toggle="tab" data-bs-target="#dsa-data" type="button" role="tab">
                        DSA Submissions
                    </button>
                </li>
            </ul>
            
            <div class="tab-content" id="dataTabsContent">
                <!-- Resume Analyses Tab -->
                <div class="tab-pane fade show active" id="resume-data" role="tabpanel">
                    <div id="resumeList" class="resume-list">
                        <!-- Resume cards will be loaded here -->
                        <div class="text-center py-5" id="resumeLoader">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Loading resume analyses...</p>
                        </div>
                    </div>
                </div>
                
                <!-- Interview Transcripts Tab -->
                <div class="tab-pane fade" id="interview-data" role="tabpanel">
                    <div id="transcriptList" class="transcript-list">
                        <!-- Transcript cards will be loaded here -->
                        <div class="text-center py-5" id="transcriptLoader">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Loading interview transcripts...</p>
                        </div>
                    </div>
                </div>
                
                <!-- DSA Submissions Tab -->
                <div class="tab-pane fade" id="dsa-data" role="tabpanel">
                    <div id="dsaSubmissionsList" class="dsa-submissions-list">
                        <!-- DSA submission cards will be loaded here -->
                        <div class="text-center py-5" id="dsaLoader">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Loading DSA submissions...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    
        <!-- Resume View Modal -->
        <div class="modal fade" id="resumeModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Resume Analysis Details</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body" id="resumeModalBody">
                        <!-- Resume details will be loaded here -->
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    
        <!-- Transcript View Modal -->
        <div class="modal fade" id="transcriptModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Interview Transcript Details</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body" id="transcriptModalBody">
                        <!-- Transcript details will be loaded here -->
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- DSA Submission View Modal -->
        <div class="modal fade" id="dsaSubmissionModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">DSA Submission Details</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body" id="dsaSubmissionModalBody">
                        <!-- DSA submission details will be loaded here -->
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>

    <footer class="bg-dark text-white py-3">
        <div class="container text-center">
            <p>&copy; 2025 AI Career Tools. All rights reserved.</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Fetch data from the API endpoints
        document.addEventListener('DOMContentLoaded', function() {
            fetchResumeData();
            fetchTranscriptData();
            fetchDsaSubmissionData();
            
            document.getElementById('refreshData').addEventListener('click', function() {
                fetchResumeData();
                fetchTranscriptData();
                fetchDsaSubmissionData();
            });
            
            document.getElementById('searchInput').addEventListener('input', filterData);
            document.getElementById('dateFilter').addEventListener('change', filterData);
        });
        
        function fetchResumeData() {
            document.getElementById('resumeLoader').style.display = 'block';
            fetch('/api/resumes')
                .then(response => response.json())
                .then(data => {
                    displayResumeData(data);
                    document.getElementById('resumeLoader').style.display = 'none';
                })
                .catch(error => {
                    console.error('Error fetching resume data:', error);
                    document.getElementById('resumeLoader').style.display = 'none';
                    document.getElementById('resumeList').innerHTML = '<div class="alert alert-danger">Error loading resume data. Please try again.</div>';
                });
        }
        
        function fetchTranscriptData() {
            document.getElementById('transcriptLoader').style.display = 'block';
            fetch('/api/transcripts')
                .then(response => response.json())
                .then(data => {
                    displayTranscriptData(data);
                    document.getElementById('transcriptLoader').style.display = 'none';
                })
                .catch(error => {
                    console.error('Error fetching transcript data:', error);
                    document.getElementById('transcriptLoader').style.display = 'none';
                    document.getElementById('transcriptList').innerHTML = '<div class="alert alert-danger">Error loading transcript data. Please try again.</div>';
                });
        }
        
        function fetchDsaSubmissionData() {
            document.getElementById('dsaLoader').style.display = 'block';
            fetch('/api/dsa-submissions')
                .then(response => response.json())
                .then(data => {
                    displayDsaSubmissionData(data);
                    document.getElementById('dsaLoader').style.display = 'none';
                })
                .catch(error => {
                    console.error('Error fetching DSA submission data:', error);
                    document.getElementById('dsaLoader').style.display = 'none';
                    document.getElementById('dsaSubmissionsList').innerHTML = '<div class="alert alert-danger">Error loading DSA submission data. Please try again.</div>';
                });
        }

        
        function displayResumeData(resumes) {
            const resumeList = document.getElementById('resumeList');
            resumeList.innerHTML = '';
            
            if (!resumes || resumes.length === 0) {
                resumeList.innerHTML = '<div class="alert alert-info">No resume analyses found.</div>';
                return;
            }
            
            resumes.forEach(resume => {
                const card = document.createElement('div');
                card.className = 'card resume-card';
                card.dataset.candidateName = resume.candidate_name.toLowerCase();
                card.dataset.date = resume.date;
                
                let ratingDisplay = '';
                if (resume.analysis && resume.analysis.rating) {
                    const ratingValue = resume.analysis.rating.replace('/10', '');
                    ratingDisplay = `<span class="badge bg-primary float-end">${resume.analysis.rating}</span>`;
                }
                
                card.innerHTML = `
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>${resume.candidate_name}</span>
                        ${ratingDisplay}
                    </div>
                    <div class="card-body">
                        <p class="timestamp">Analyzed on ${new Date(resume.date).toLocaleString()}</p>
                        <p class="summary">${resume.analysis && resume.analysis.summary ? resume.analysis.summary : 'No summary available'}</p>
                        <button class="btn btn-sm btn-primary view-resume-details" data-resume-id="${resume._id}">View Full Analysis</button>
                    </div>
                `;
                
                resumeList.appendChild(card);
            });
            
            // Add event listeners to the view buttons
            document.querySelectorAll('.view-resume-details').forEach(button => {
                button.addEventListener('click', function() {
                    const resumeId = this.dataset.resumeId;
                    const resume = resumes.find(r => r._id === resumeId);
                    showResumeDetails(resume);
                });
            });
        }
        
        function displayTranscriptData(transcripts) {
            const transcriptList = document.getElementById('transcriptList');
            transcriptList.innerHTML = '';
            
            if (!transcripts || transcripts.length === 0) {
                transcriptList.innerHTML = '<div class="alert alert-info">No interview transcripts found.</div>';
                return;
            }
            
            transcripts.forEach(transcript => {
                const card = document.createElement('div');
                card.className = 'card transcript-card';
                card.dataset.candidateName = transcript.candidate_name.toLowerCase();
                card.dataset.date = transcript.date;
                
                card.innerHTML = `
                    <div class="card-header">
                        ${transcript.candidate_name}
                    </div>
                    <div class="card-body">
                        <p class="timestamp">Interview conducted on ${new Date(transcript.date).toLocaleString()}</p>
                        <p>${transcript.message_count} messages exchanged</p>
                        <button class="btn btn-sm btn-primary view-transcript-details" data-transcript-id="${transcript._id}">View Full Transcript</button>
                    </div>
                `;
                
                transcriptList.appendChild(card);
            });
            
            // Add event listeners to the view buttons
            document.querySelectorAll('.view-transcript-details').forEach(button => {
                button.addEventListener('click', function() {
                    const transcriptId = this.dataset.transcriptId;
                    const transcript = transcripts.find(t => t._id === transcriptId);
                    showTranscriptDetails(transcript);
                });
            });
        }
        
        function displayDsaSubmissionData(submissions) {
            const submissionsList = document.getElementById('dsaSubmissionsList');
            submissionsList.innerHTML = '';
            
            if (!submissions || submissions.length === 0) {
                submissionsList.innerHTML = '<div class="alert alert-info">No DSA submissions found.</div>';
                return;
            }
            
            submissions.forEach(submission => {
                const card = document.createElement('div');
                card.className = 'card submission-card';
                card.dataset.questionTitle = submission.question_title.toLowerCase();
                card.dataset.date = submission.date;
                card.dataset.difficulty = submission.difficulty;
                
                const difficultyClass = `difficulty-badge-${submission.difficulty.toLowerCase()}`;
                
                card.innerHTML = `
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">${submission.question_title}</h5>
                        <div>
                            <span class="badge ${difficultyClass}">
                                ${submission.difficulty.charAt(0).toUpperCase() + submission.difficulty.slice(1)}
                            </span>
                            <small class="text-muted ms-2">${submission.date}</small>
                        </div>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-sm btn-primary view-submission-details" data-submission-id="${submission._id}">
                            View Solution & Analysis
                        </button>
                    </div>
                `;
                
                submissionsList.appendChild(card);
            });
            
            // Add event listeners to the view buttons
            document.querySelectorAll('.view-submission-details').forEach(button => {
                button.addEventListener('click', function() {
                    const submissionId = this.dataset.submissionId;
                    const submission = submissions.find(s => s._id === submissionId);
                    showDsaSubmissionDetails(submission);
                });
            });
        }
        
        function showResumeDetails(resume) {
            const modalBody = document.getElementById('resumeModalBody');
            modalBody.innerHTML = '';
            
            if (!resume || !resume.analysis) {
                modalBody.innerHTML = '<div class="alert alert-warning">No analysis data available for this resume.</div>';
                return;
            }
            
            let ratingHtml = '';
            if (resume.analysis.rating) {
                const ratingValue = parseFloat(resume.analysis.rating.toString().replace('/10', ''));
                const ratingClass = ratingValue >= 7 ? 'text-success' : 
                                   ratingValue >= 5 ? 'text-warning' : 'text-danger';
                
                ratingHtml = `
                    <div class="rating-display mb-4">
                        <h5>Overall Rating</h5>
                        <span class="${ratingClass}">${resume.analysis.rating}</span>
                    </div>
                `;
            }
            
            let strengthsHtml = '';
            if (resume.analysis.strengths && resume.analysis.strengths.length) {
                strengthsHtml = `
                    <div class="list-section strengths">
                        <h6>Strengths</h6>
                        <ul>
                            ${resume.analysis.strengths.map(strength => `<li>${strength}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }
            
            let weaknessesHtml = '';
            if (resume.analysis.weaknesses && resume.analysis.weaknesses.length) {
                weaknessesHtml = `
                    <div class="list-section weaknesses">
                        <h6>Weaknesses</h6>
                        <ul>
                            ${resume.analysis.weaknesses.map(weakness => `<li>${weakness}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }
            
            let improvementsHtml = '';
            if (resume.analysis.areas_for_improvement && resume.analysis.areas_for_improvement.length) {
                improvementsHtml = `
                    <div class="list-section improvements">
                        <h6>Areas for Improvement</h6>
                        <ul>
                            ${resume.analysis.areas_for_improvement.map(improvement => `<li>${improvement}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }
            
            let summaryHtml = '';
            if (resume.analysis.summary) {
                summaryHtml = `
                    <div class="summary-section mb-4">
                        <h6>Summary</h6>
                        <p>${resume.analysis.summary}</p>
                    </div>
                `;
            }
            
            modalBody.innerHTML = `
                <h4 class="mb-3">${resume.candidate_name}'s Resume Analysis</h4>
                <p class="timestamp">Analyzed on ${new Date(resume.date).toLocaleString()}</p>
                
                ${summaryHtml}
                ${ratingHtml}
                
                <div class="analysis-details">
                    ${strengthsHtml}
                    ${weaknessesHtml}
                    ${improvementsHtml}
                </div>
            `;
            
            const resumeModal = new bootstrap.Modal(document.getElementById('resumeModal'));
            resumeModal.show();
        }
        
        function showTranscriptDetails(transcript) {
            const modalBody = document.getElementById('transcriptModalBody');
            modalBody.innerHTML = '';
            
            if (!transcript || !transcript.transcript || !transcript.transcript.length) {
                modalBody.innerHTML = '<div class="alert alert-warning">No transcript data available for this interview.</div>';
                return;
            }
            
            const messageHtml = transcript.transcript.map(msg => {
                const role = msg.role;
                const content = msg.content;
                const roleClass = role === 'user' ? 'user-message' : 'assistant-message';
                const roleLabel = role === 'user' ? 'Candidate' : 'Interviewer';
                
                return `
                    <div class="message ${roleClass}">
                        <strong>${roleLabel}:</strong>
                        <div class="content">${content}</div>
                    </div>
                `;
            }).join('');
            
            modalBody.innerHTML = `
                <h4 class="mb-3">${transcript.candidate_name}'s Interview Transcript</h4>
                <p class="timestamp">Interview conducted on ${new Date(transcript.date).toLocaleString()}</p>
                
                <div class="message-list mt-4">
                    ${messageHtml}
                </div>
            `;
            
            const transcriptModal = new bootstrap.Modal(document.getElementById('transcriptModal'));
            transcriptModal.show();
        }
        
        function showDsaSubmissionDetails(submission) {
            const modalBody = document.getElementById('dsaSubmissionModalBody');
            modalBody.innerHTML = '';
            
            if (!submission) {
                modalBody.innerHTML = '<div class="alert alert-warning">No data available for this submission.</div>';
                return;
            }
            
            const difficultyClass = `difficulty-badge-${submission.difficulty.toLowerCase()}`;
            
            modalBody.innerHTML = `
                <h4 class="mb-3">${submission.question_title}</h4>
                <div class="d-flex justify-content-between mb-3">
                    <span class="badge ${difficultyClass}">
                        ${submission.difficulty.charAt(0).toUpperCase() + submission.difficulty.slice(1)}
                    </span>
                    <small class="text-muted">Submitted on ${submission.date}</small>
                </div>
                
                <div class="accordion" id="submissionDetails">
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                    data-bs-target="#collapseSolution">
                                Your Solution
                            </button>
                        </h2>
                        <div id="collapseSolution" class="accordion-collapse collapse" 
                             data-bs-parent="#submissionDetails">
                            <div class="accordion-body">
                                <div class="solution-code">${submission.user_solution}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button" type="button" data-bs-toggle="collapse" 
                                    data-bs-target="#collapseAnalysis">
                                AI Analysis
                            </button>
                        </h2>
                        <div id="collapseAnalysis" class="accordion-collapse collapse show" 
                             data-bs-parent="#submissionDetails">
                            <div class="accordion-body">
                                <div class="analysis-content">${submission.analysis}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            const submissionModal = new bootstrap.Modal(document.getElementById('dsaSubmissionModal'));
            submissionModal.show();
        }
        
        function filterData() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const dateFilter = document.getElementById('dateFilter').value;
            
            // Filter resume cards
            document.querySelectorAll('.resume-card').forEach(card => {
                const candidateName = card.dataset.candidateName;
                const date = new Date(card.dataset.date);
                
                const matchesSearch = !searchTerm || candidateName.includes(searchTerm);
                const matchesDate = dateMatchesFilter(date, dateFilter);
                
                card.style.display = matchesSearch && matchesDate ? 'block' : 'none';
            });
            
            // Filter transcript cards
            document.querySelectorAll('.transcript-card').forEach(card => {
                const candidateName = card.dataset.candidateName;
                const date = new Date(card.dataset.date);
                
                const matchesSearch = !searchTerm || candidateName.includes(searchTerm);
                const matchesDate = dateMatchesFilter(date, dateFilter);
                
                card.style.display = matchesSearch && matchesDate ? 'block' : 'none';
            });
            
            // Filter DSA submission cards
            document.querySelectorAll('.submission-card').forEach(card => {
                const questionTitle = card.dataset.questionTitle;
                const date = new Date(card.dataset.date);
                
                const matchesSearch = !searchTerm || questionTitle.includes(searchTerm);
                const matchesDate = dateMatchesFilter(date, dateFilter);
                
                card.style.display = matchesSearch && matchesDate ? 'block' : 'none';
            });
        }
        
        function dateMatchesFilter(date, filter) {
            if (filter === 'all') return true;
            
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            
            if (filter === 'today') {
                return date >= today;
            }
            
            if (filter === 'week') {
                const weekStart = new Date(today);
                weekStart.setDate(today.getDate() - today.getDay());
                return date >= weekStart;
            }
            
            if (filter === 'month') {
                const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
                return date >= monthStart;
            }
            
            return true;
        }
    </script>
</body>
</html>